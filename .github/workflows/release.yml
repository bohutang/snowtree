name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create_release:
    name: Create draft release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create draft GitHub release (with notes)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [ -z "${TAG}" ]; then
            echo "Missing GITHUB_REF_NAME" >&2
            exit 1
          fi

          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists; leaving as-is"
            exit 0
          fi

          PREV="$(git tag --sort=-version:refname | grep -E '^v' | grep -v "^${TAG}$" | head -n 1 || true)"
          echo "Creating draft release: ${TAG} (previous: ${PREV:-<none>})"

          # Generate release notes with changelog
          if [ -n "${PREV}" ]; then
            gh api "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
              -f "tag_name=${TAG}" \
              -f "previous_tag_name=${PREV}" \
              > release-notes.json
          else
            gh api "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
              -f "tag_name=${TAG}" \
              > release-notes.json
          fi

          python3 - <<'PY'
          import json
          with open("release-notes.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          body = data.get("body") or ""
          with open("release-notes.md", "w", encoding="utf-8") as f:
              f.write(body)
              if not body.endswith("\n"):
                  f.write("\n")
          PY

          # Add commits section
          {
            echo ""
            echo "## Commits"
            if [ -n "${PREV}" ]; then
              git log --no-merges --pretty=format:'- %s (%h)' "${PREV}..${TAG}" || true
            else
              git log --no-merges -n 50 --pretty=format:'- %s (%h)' "${TAG}" || true
            fi
            echo ""
          } >> release-notes.md

          # Create draft release with full changelog
          gh release create "${TAG}" --draft --latest=false --verify-tag --notes-file release-notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build & upload assets (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: create_release
    permissions:
      contents: write
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.15.1'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm --filter @snowtree/core build && pnpm --filter @snowtree/desktop build && pnpm --filter @snowtree/ui build

      - name: Prepare release app directory (prod deps)
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_APP_DIR="${RUNNER_TEMP}/release-app"
          echo "RELEASE_APP_DIR=${RELEASE_APP_DIR}" >> "${GITHUB_ENV}"

          rm -rf "${RELEASE_APP_DIR}"
          mkdir -p "${RELEASE_APP_DIR}/packages/desktop" "${RELEASE_APP_DIR}/packages/ui" "${RELEASE_APP_DIR}/packages/core"

          cp package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc LICENSE "${RELEASE_APP_DIR}/"
          cp -R packages/desktop/dist "${RELEASE_APP_DIR}/packages/desktop/dist"
          cp -R packages/desktop/assets "${RELEASE_APP_DIR}/packages/desktop/assets"
          cp packages/desktop/package.json "${RELEASE_APP_DIR}/packages/desktop/package.json"
          cp -R packages/ui/dist "${RELEASE_APP_DIR}/packages/ui/dist"

          cp "${GITHUB_WORKSPACE}/packages/core/package.json" "${RELEASE_APP_DIR}/packages/core/package.json"
          cp -R "${GITHUB_WORKSPACE}/packages/core/dist" "${RELEASE_APP_DIR}/packages/core/dist"
          cp -R "${GITHUB_WORKSPACE}/packages/core/dist-cjs" "${RELEASE_APP_DIR}/packages/core/dist-cjs"

          pushd "${RELEASE_APP_DIR}"
          pnpm install -P --frozen-lockfile --ignore-scripts
          popd

      - name: Rebuild native dependencies (Electron)
        shell: bash
        run: |
          set -euo pipefail
          pushd "${RELEASE_APP_DIR}"
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" install-app-deps
          popd

      - name: Build artifacts (no publish)
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" --projectDir "${RELEASE_APP_DIR}" --publish never

      - name: Verify packaged app contains core (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          ZIP="$(ls -1 "${RELEASE_APP_DIR}/dist-electron/"*macOS-arm64.zip | head -n 1)"
          TMP_DIR="${RUNNER_TEMP}/verify-app"
          rm -rf "${TMP_DIR}"
          mkdir -p "${TMP_DIR}"
          unzip -q "${ZIP}" -d "${TMP_DIR}"
          APP_ASAR="$(find "${TMP_DIR}" -path '*snowtree.app/Contents/Resources/app.asar' | head -n 1)"
          echo "Verifying asar: ${APP_ASAR}"
          "${GITHUB_WORKSPACE}/node_modules/.bin/asar" list "${APP_ASAR}" | grep -q "node_modules/@snowtree/core/dist-cjs/types/models.js"

      - name: Publish to GitHub Releases
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" --projectDir "${RELEASE_APP_DIR}" --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize_release:
    name: Publish release notes
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Publish release (undraft)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [ -z "${TAG}" ]; then
            echo "Missing GITHUB_REF_NAME" >&2
            exit 1
          fi

          echo "Publishing release: ${TAG}"
          gh release edit "${TAG}" --draft=false --latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
